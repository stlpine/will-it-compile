name: PR CI

on:
  pull_request:
    branches:
      - main

# Cancel in-progress runs when a new commit is pushed to the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  GO_VERSION: "1.25"

jobs:
  # Detect what files changed to run appropriate jobs
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Check out code
        uses: actions/checkout@v5

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - '**'
              - '!web/**'
            frontend:
              - 'web/**'

  lint:
    name: Lint
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v9

  unit-test:
    name: Unit Test
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download dependencies
        run: go mod download

      - name: Run unit tests
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./internal/...

      - name: Display coverage
        run: go tool cover -func=coverage.out

  integration-test:
    name: Integration Test
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest

    # Redis service for integration tests
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Check out code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download dependencies
        run: go mod download

      - name: Pull official compiler images
        run: |
          docker pull gcc:9

      - name: Run integration tests
        env:
          REDIS_ADDR: localhost:6379
          MINIMAL_IMAGE_VALIDATION: "true"
        run: go test -v -race ./tests/integration/...

  build:
    name: Build
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download dependencies
        run: go mod download

      - name: Build API server
        run: make build

      - name: Verify binary
        run: |
          if [ ! -f ./bin/will-it-compile-api ]; then
            echo "Binary not found"
            exit 1
          fi
          file ./bin/will-it-compile-api

  docker-build:
    name: Docker Build
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API server image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          # Single-arch for PR (faster): native platform only
          platforms: linux/amd64
          tags: stlpine/will-it-compile-api:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker

      - name: Verify API image
        run: |
          docker images
          docker images | grep will-it-compile-api

  frontend-type-check:
    name: Frontend Type Check
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web

    steps:
      - name: Check out code
        uses: actions/checkout@v5

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false
          package_json_file: "web/package.json"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "pnpm"
          cache-dependency-path: web/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run type check
        run: pnpm type-check

  # This is the ONLY required check in GitHub branch protection
  # All other jobs are dependencies of this job
  all-checks-pass:
    name: All Checks Pass
    runs-on: ubuntu-latest
    needs:
      [
        changes,
        lint,
        unit-test,
        integration-test,
        build,
        docker-build,
        frontend-type-check,
      ]
    if: always() # Run even if some jobs are skipped
    steps:
      - name: Verify all required jobs succeeded
        run: |
          # Get all job results
          CHANGES_RESULT="${{ needs.changes.result }}"
          LINT_RESULT="${{ needs.lint.result }}"
          UNIT_TEST_RESULT="${{ needs.unit-test.result }}"
          INTEGRATION_TEST_RESULT="${{ needs.integration-test.result }}"
          BUILD_RESULT="${{ needs.build.result }}"
          DOCKER_BUILD_RESULT="${{ needs.docker-build.result }}"
          FRONTEND_TYPE_CHECK_RESULT="${{ needs.frontend-type-check.result }}"

          echo "Job Results:"
          echo "  changes: $CHANGES_RESULT"
          echo "  lint: $LINT_RESULT"
          echo "  unit-test: $UNIT_TEST_RESULT"
          echo "  integration-test: $INTEGRATION_TEST_RESULT"
          echo "  build: $BUILD_RESULT"
          echo "  docker-build: $DOCKER_BUILD_RESULT"
          echo "  frontend-type-check: $FRONTEND_TYPE_CHECK_RESULT"

          # Check if any required job failed
          if [[ "$CHANGES_RESULT" == "failure" ]] || \
             [[ "$LINT_RESULT" == "failure" ]] || \
             [[ "$UNIT_TEST_RESULT" == "failure" ]] || \
             [[ "$INTEGRATION_TEST_RESULT" == "failure" ]] || \
             [[ "$BUILD_RESULT" == "failure" ]] || \
             [[ "$DOCKER_BUILD_RESULT" == "failure" ]] || \
             [[ "$FRONTEND_TYPE_CHECK_RESULT" == "failure" ]]; then
            echo "❌ One or more required jobs failed"
            exit 1
          fi

          # Check if any required job was cancelled
          if [[ "$CHANGES_RESULT" == "cancelled" ]] || \
             [[ "$LINT_RESULT" == "cancelled" ]] || \
             [[ "$UNIT_TEST_RESULT" == "cancelled" ]] || \
             [[ "$INTEGRATION_TEST_RESULT" == "cancelled" ]] || \
             [[ "$BUILD_RESULT" == "cancelled" ]] || \
             [[ "$DOCKER_BUILD_RESULT" == "cancelled" ]] || \
             [[ "$FRONTEND_TYPE_CHECK_RESULT" == "cancelled" ]]; then
            echo "❌ One or more required jobs was cancelled"
            exit 1
          fi

          echo "✅ All required jobs passed or were appropriately skipped"
