# CLI Implementation Summary

## Overview

Added a professional command-line interface using Cobra, the industry-standard CLI framework used by kubectl, helm, docker, and many other tools.

## What Was Added

### New Files Created

```
cmd/cli/
├── main.go                    # CLI entry point
└── commands/
    ├── root.go                # Root command & global flags
    ├── compile.go             # Compile command
    ├── environments.go        # List environments command
    └── version.go             # Version command
```

### Documentation

- **CLI_GUIDE.md** - Comprehensive CLI user guide
- **README.md** - Updated with CLI quick start section

### Build System

- Updated **Makefile** with:
  - `build-cli` - Build CLI only
  - `build-api` - Build API server only
  - `build` - Build both
  - `install` - Install CLI to $GOPATH/bin
  - Version info injection via ldflags

## Features

### Commands

#### 1. `compile` - Compile Source Files

```bash
will-it-compile compile mycode.cpp [flags]
```

**Features:**
- Auto-detects language from file extension (.cpp, .cc, .cxx, .c++, .c)
- Supports C++ standards (c++11, c++14, c++17, c++20, c++23)
- Custom compiler selection
- Configurable timeout
- Show/hide stdout/stderr
- Verbose and quiet modes

**Example:**
```bash
will-it-compile compile hello.cpp --std=c++20 --verbose
```

#### 2. `environments` - List Supported Environments

```bash
will-it-compile environments [flags]
```

**Features:**
- Multiple output formats (table, list, json)
- Shows languages, compilers, standards, OSes, architectures

**Example:**
```bash
will-it-compile env --output=json
```

#### 3. `version` - Show Version Info

```bash
will-it-compile version [flags]
```

**Features:**
- Full version info (version, commit, build date, Go version, OS/arch)
- Short mode (version number only)
- Version info embedded at build time

**Example:**
```bash
will-it-compile version --short
```

#### 4. `completion` - Shell Completion

Auto-generated by Cobra for bash, zsh, fish, and PowerShell.

```bash
will-it-compile completion bash > /etc/bash_completion.d/will-it-compile
```

### Global Flags

Available on all commands:
- `--verbose` / `-v` - Verbose output
- `--quiet` / `-q` - Quiet mode (errors only)
- `--help` / `-h` - Show help

## Architecture

### Shared Code Reuse

Both CLI and API server use the **same internal packages**:

```
CLI Tool → internal/compiler → runtime interface → Docker/Kubernetes
API Server → internal/compiler → runtime interface → Docker/Kubernetes
```

**Key Point:** The CLI always uses Docker runtime (local execution), while the API server auto-detects the environment (Docker locally, Kubernetes in production).

### Runtime Selection

```go
// CLI (cmd/cli/commands/compile.go)
dockerRuntime, err := docker.NewDockerRuntime()
comp := compiler.NewCompilerWithRuntime(dockerRuntime)

// API (cmd/api/main.go)
comp, err := compiler.NewCompiler() // Auto-detects Docker or K8s
```

## Build Details

### Version Embedding

Version information is embedded at build time using `-ldflags`:

```makefile
VERSION?=dev
COMMIT?=$(shell git rev-parse --short HEAD 2>/dev/null || echo "none")
BUILD_DATE?=$(shell date -u '+%Y-%m-%d_%H:%M:%S')
LDFLAGS=-ldflags "-X github.com/stlpine/will-it-compile/cmd/cli/commands.version=$(VERSION) \
                   -X github.com/stlpine/will-it-compile/cmd/cli/commands.commit=$(COMMIT) \
                   -X github.com/stlpine/will-it-compile/cmd/cli/commands.buildDate=$(BUILD_DATE)"
```

**Usage:**
```bash
# Development build (version=dev)
make build-cli

# Production build with version
make build-cli VERSION=v1.0.0
```

### Binary Sizes

- **CLI**: ~47MB
- **API Server**: ~56MB

Both are statically linked and can be distributed as single binaries.

## Usage Examples

### Basic Compilation

```bash
$ will-it-compile compile hello.cpp
Compiling hello.cpp...
✓ Compilation successful (exit code: 0, duration: 1.234s)
```

### Compilation with Error

```bash
$ will-it-compile compile error.cpp
Compiling error.cpp...
✗ Compilation failed (exit code: 1, duration: 0.567s)

--- Stderr ---
error.cpp:2:14: error: expected ';' after return statement
```

### Scripting Integration

```bash
#!/bin/bash
if will-it-compile compile mycode.cpp --quiet; then
    echo "✓ Code compiles"
else
    echo "✗ Compilation failed"
    exit 1
fi
```

### CI/CD Integration

```yaml
# GitHub Actions
- name: Check compilation
  run: |
    find src -name "*.cpp" -exec will-it-compile compile {} \;
```

## Dependencies Added

### Cobra Framework

```
go get github.com/spf13/cobra@latest
```

**What it provides:**
- Command structure and routing
- Flag parsing (persistent and local flags)
- Auto-generated help and usage
- Shell completion generation
- Subcommand management

**Additional transitive dependencies:**
- `github.com/spf13/pflag` - POSIX/GNU-style flags
- `github.com/inconshreveable/mousetrap` - Windows CLI support

## Key Implementation Details

### Language Detection

```go
func detectLanguage(filePath string) (models.Language, error) {
    ext := filepath.Ext(filePath)
    switch ext {
    case ".cpp", ".cc", ".cxx", ".c++":
        return models.LanguageCpp, nil
    case ".c":
        return models.LanguageC, nil
    default:
        return "", fmt.Errorf("unsupported file extension: %s", ext)
    }
}
```

### Output Control

The CLI provides three output modes:
1. **Normal** - Info messages + stdout/stderr
2. **Verbose** (`-v`) - Additional debug information
3. **Quiet** (`-q`) - Errors only (for scripting)

### Exit Codes

- `0` - Compilation successful
- `1` - Compilation failed or error occurred

This makes the CLI script-friendly:
```bash
will-it-compile compile code.cpp && echo "Success" || echo "Failed"
```

## Future TUI Integration

The CLI is designed to support TUI (Terminal User Interface) mode in the future:

### Planned Structure

```go
// cmd/cli/main.go (future)
func main() {
    if len(os.Args) == 1 {
        // No arguments → Launch TUI
        tui.Run()
    } else {
        // Has arguments → CLI mode
        commands.Execute()
    }
}
```

### TUI Possibilities

Using **Bubble Tea** (recommended):
- Interactive compilation interface
- Real-time compilation status
- File browser for selecting files
- Environment selector
- Compilation history viewer

## Homebrew Distribution (Future)

The CLI is ready for Homebrew distribution:

```ruby
# Formula: homebrew-tap/will-it-compile.rb
class WillItCompile < Formula
  desc "Check if code compiles in isolated environments"
  homepage "https://github.com/stlpine/will-it-compile"
  url "https://github.com/.../will-it-compile-v1.0.0-darwin-arm64.tar.gz"
  version "1.0.0"
  sha256 "..."

  depends_on "docker"

  def install
    bin.install "will-it-compile"
  end

  test do
    system "#{bin}/will-it-compile", "version"
  end
end
```

**Installation:**
```bash
brew install will-it-compile
```

## Comparison: CLI vs API

| Feature | CLI | API Server |
|---------|-----|------------|
| **Use Case** | Local development, scripting | Production service |
| **Runtime** | Always Docker | Docker or Kubernetes |
| **Interface** | Terminal (stdin/stdout) | HTTP/JSON |
| **Authentication** | None | Rate limiting |
| **Concurrency** | Sequential | Concurrent (goroutines) |
| **Job Storage** | N/A | In-memory (MVP) |
| **Distribution** | Single binary | Container image |
| **Configuration** | Flags only | Environment variables |

## Testing

```bash
# Build the CLI
make build-cli

# Test help
./bin/will-it-compile --help

# Test version
./bin/will-it-compile version

# Test environments
./bin/will-it-compile environments

# Test compilation (requires Docker images)
make docker-build
echo 'int main() { return 0; }' > test.cpp
./bin/will-it-compile compile test.cpp
```

## Benefits of Cobra

1. **Industry Standard** - Used by kubectl, helm, docker, hugo
2. **Feature Rich** - Flags, subcommands, aliases, help generation
3. **Shell Completion** - Auto-generated for all major shells
4. **Validation** - Built-in argument validation
5. **Extensible** - Easy to add new commands
6. **Documentation** - Auto-generated help and usage
7. **Tested** - Battle-tested in production tools
8. **Community** - Large ecosystem and support

## Next Steps

Potential enhancements:

1. **Configuration File**
   - `~/.will-it-compile.yaml`
   - Support for default flags
   - Multiple profiles

2. **Watch Mode**
   - `will-it-compile compile --watch mycode.cpp`
   - Auto-recompile on file changes

3. **TUI Mode**
   - Interactive interface with Bubble Tea
   - File browser, environment selector
   - Real-time compilation status

4. **Binary Extraction**
   - `will-it-compile compile --extract-binary mycode.cpp`
   - Save compiled binary locally

5. **Caching**
   - Cache compilation results
   - Skip recompilation if source unchanged

6. **Remote Mode**
   - Connect to API server instead of Docker
   - `will-it-compile compile --remote=https://api.example.com`

## Documentation

- **CLI_GUIDE.md** - Complete user guide with examples
- **README.md** - Quick start and overview
- Built-in help - `will-it-compile --help`
- Command help - `will-it-compile compile --help`

## Conclusion

The CLI implementation provides:
- ✅ Professional command-line interface
- ✅ Industry-standard framework (Cobra)
- ✅ Full feature parity with API for compilation
- ✅ Script-friendly (exit codes, quiet mode)
- ✅ Extensible architecture
- ✅ Ready for future TUI mode
- ✅ Homebrew-ready for distribution
- ✅ Comprehensive documentation

The CLI shares all core compilation logic with the API server, ensuring consistency while providing a streamlined local development experience.
