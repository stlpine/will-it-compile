# Production values for will-it-compile
# This overrides default values for production deployment

replicaCount: 3

image:
  repository: stlpine/will-it-compile-api
  pullPolicy: Always
  tag: ""  # Specify git SHA or semantic version at deploy time, never use 'latest'

imagePullSecrets: []

nameOverride: ""
fullnameOverride: ""

# Compiler images matching configs/environments.yaml
# Production environment includes all supported versions
compilerImages:
  # C/C++ - Official GCC images (Debian-based, no alpine)
  # Supports C (GCC 9, 11, 13) and C++ (GCC 9, 10, 11, 12, 13)
  gcc:
    repository: gcc
    tags: ["9", "10", "11", "12", "13"]
    pullPolicy: IfNotPresent

  # Go - Official Golang images (Alpine-based)
  # Supports versions 1.20, 1.21, 1.22, 1.23
  go:
    repository: golang
    tags: ["1.20-alpine", "1.21-alpine", "1.22-alpine", "1.23-alpine"]
    pullPolicy: IfNotPresent

  # Rust - Official Rust images (Alpine-based)
  # Supports versions 1.70, 1.75, 1.80
  rust:
    repository: rust
    tags: ["1.70-alpine", "1.75-alpine", "1.80-alpine"]
    pullPolicy: IfNotPresent

serviceAccount:
  create: true
  annotations:
    # Add any cloud-specific annotations
    # iam.gke.io/gcp-service-account: will-it-compile@project.iam.gserviceaccount.com

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8080"
  prometheus.io/path: "/metrics"

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000
  seccompProfile:
    type: RuntimeDefault

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false
  runAsNonRoot: true
  runAsUser: 1000

service:
  type: ClusterIP
  port: 80
  targetPort: 8080

ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    # Enable regex for precise path matching - ensures /api takes priority over /
    nginx.ingress.kubernetes.io/use-regex: "true"
  hosts:
    - host: compile.example.com
      paths:
        # API routes - regex ensures higher priority over catch-all
        - path: /api(/|$)(.*)
          pathType: ImplementationSpecific
          backend: api
        # Web frontend - catch all other routes
        - path: /
          pathType: Prefix
          backend: web
  tls:
    - secretName: will-it-compile-tls
      hosts:
        - compile.example.com

resources:
  limits:
    cpu: 2000m
    memory: 1Gi
  requests:
    cpu: 500m
    memory: 512Mi

autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 20
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

networkPolicy:
  enabled: true
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8080
  egress:
    # DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
        - podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
    # Kubernetes API
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443
    # Redis communication (same namespace)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/component: redis
      ports:
        - protocol: TCP
          port: 6379

podDisruptionBudget:
  enabled: true
  minAvailable: 2

# Production-specific affinity rules
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - will-it-compile
          topologyKey: kubernetes.io/hostname

# Node selector for dedicated nodes (optional - uncomment to use)
# nodeSelector:
#   workload: compilation

# Tolerations for tainted nodes (optional - uncomment to use)
# tolerations:
#   - key: "workload"
#     operator: "Equal"
#     value: "compilation"
#     effect: "NoSchedule"

# Production environment variables
env:
  - name: PORT
    value: "8080"
  - name: NAMESPACE
    valueFrom:
      fieldRef:
        fieldPath: metadata.namespace
  - name: LOG_LEVEL
    value: "info"

# Redis Configuration (Production)
# Ephemeral in-memory cache - data lost on pod restart
redis:
  enabled: true
  image:
    repository: redis
    tag: "7-alpine"
    pullPolicy: IfNotPresent

  # Authentication - ENABLED for production
  auth:
    enabled: true
    password: ""  # Auto-generated on first install (store securely!)

  # Redis Configuration
  database: 0
  poolSize: 50  # Larger pool for production
  jobTTL: 48  # 48 hours for production (longer retention)
  maxMemory: "512mb"  # More memory for production
  maxMemoryPolicy: "allkeys-lru"

  # Resources - Production sizing
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 250m
      memory: 512Mi

# Worker Pool Configuration (Production)
workerPool:
  enabled: true
  maxWorkers: 20  # More workers for production
  queueSize: 500  # Larger queue for production

# Web Frontend Configuration (Production)
web:
  enabled: true  # Enable web frontend for production
  replicaCount: 2  # Start with 2 replicas for HA

  image:
    repository: stlpine/will-it-compile-web
    pullPolicy: Always
    tag: ""  # Specify git SHA or semantic version at deploy time, never use 'latest'

  service:
    type: ClusterIP
    port: 80

  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "80"
    prometheus.io/path: "/metrics"

  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 101  # nginx user
    fsGroup: 101

  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: true

  resources:
    limits:
      cpu: 500m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

  # Production-specific affinity rules for HA
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                    - web
            topologyKey: kubernetes.io/hostname

  nodeSelector: {}
  tolerations: []
