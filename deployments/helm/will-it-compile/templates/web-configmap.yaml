{{- if .Values.web.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "will-it-compile.fullname" . }}-web-nginx
  labels:
    {{- include "will-it-compile.labels" . | nindent 4 }}
    app.kubernetes.io/component: web
data:
  default.conf: |
    server {
        listen 8080;
        server_name _;
        root /usr/share/nginx/html;
        index index.html;

        # Enhanced Gzip compression for smaller transfers
        gzip on;
        gzip_vary on;
        gzip_min_length 256;
        gzip_comp_level 6;
        gzip_proxied any;
        gzip_types
            text/plain
            text/css
            text/xml
            text/javascript
            application/javascript
            application/x-javascript
            application/xml
            application/xml+rss
            application/json
            application/wasm
            font/woff
            font/woff2
            image/svg+xml;

        # Disable gzip for IE6
        gzip_disable "msie6";

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;

        # Explicitly reject /api requests that accidentally reach this container
        # This prevents serving index.html for API requests if Ingress misbehaves
        # The Ingress should route /api to the API service, but this is a safety net
        location /api/ {
            return 404 '{"error": "API endpoint not found on web server"}';
            add_header Content-Type application/json always;
        }

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # Aggressive caching for static assets (fonts, images, etc.)
        location ~* \.(jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log off;
        }

        # Cache JavaScript and CSS with versioning
        location ~* \.(js|css)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # Cache for assets directory
        location /assets/ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log off;
        }

        # No caching for index.html (SPA entry point)
        location = /index.html {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            expires 0;
        }

        # SPA fallback - serve index.html for all non-file requests
        location / {
            try_files $uri $uri/ /index.html;
        }
    }
{{- end }}
